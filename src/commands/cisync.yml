description: >
  Merge .circleci/config.yml into the other branch.
# What will this command do?
# Descriptions should be short, simple, and clear.

parameters:
  always:
    type: boolean
    default: false
    description: ""
  merge-from:
    type: string
    default: $CIRCLE_BRANCH
    description: "Branch name to merge from. If not specified, the environment variable CIRCLE_BRANCH will be used."
  merge-to:
    type: string
    default: "ALL"
    description: "Branch name to merge into. If not specified, all branches except merge-from will be used."
  user-name:
    type: string
    default: "cisync"
    description: "GitHub user.name to create the cisync commits."
  user-email:
    type: string
    default: "cisync@rhems-japan.co.jp"
    description: "GitHub user.email to create the cisync commits."
  fingerprint:
    type: string
    description: "Fingerprint of SSH keys that have write permission to the repository. It is recommended to use deploy key. See https://circleci.com/docs/2.0/gh-bb-integration/#creating-a-github-deploy-key."

steps:
  - run:
      name: check always
      command: |
        if ! << parameters.always >>; then
          commit_subject=$(git log -1 --pretty=%s.)
          echo "${commit_subject}"
          match=$(echo "${commit_subject}" | sed -rn '/.*\[cisync\].*/p')
          echo "${match}"
          if [ -z "${match}" ]; then
            circleci-agent step halt
          fi
        fi
  - add_ssh_keys:
      fingerprints:
        - << parameters.fingerprint >>
  - run:
      environment:
        MERGE_FROM: << parameters.merge-from >>
        MERGE_TO: << parameters.merge-to >>
        USER_NAME: << parameters.user-name >>
        USER_EMAIL: << parameters.user-email >>
      name: cisync
      command: << include(scripts/cisync.sh) >>
